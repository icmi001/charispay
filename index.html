<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CharisPay</title>
<!-- PWA -->
<meta name="theme-color" content="#4B0082">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="https://i.imgur.com/jT9Dl9w.png" sizes="192x192">
<link rel="apple-touch-icon" href="https://i.imgur.com/jT9Dl9w.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://js.paystack.co/v1/inline.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#2C003E,#4B0082);color:#fff;overflow-x:hidden;min-height:100vh;}
a{color:inherit;text-decoration:none;}
/* TOP NAV */
#topNav {
  position: fixed; top: 0; left: 0; width: 100%; background: #fff;
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000;
}
#topNav .logo img { height: 45px; }
#topNav .nav-icons { display: flex; gap: 8px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
.nav-icon {
  width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
  font-size: 20px; color: #4B0082; cursor: pointer; border-radius: 12px; transition: .3s;
  position: relative; flex-shrink: 0;
}
.nav-icon:hover, .nav-icon.active { background: #f0e6ff; color: #6A0DAD; transform: scale(1.1); }
.nav-icon::after { content: attr(title); position: absolute; bottom: -35px; left: 50%;
  transform: translateX(-50%); background: #333; color: #fff; padding: 6px 12px;
  border-radius: 6px; font-size: 12px; opacity: 0; transition: .2s; pointer-events: none;
}
.nav-icon:hover::after { opacity: 1; }
/* MAIN */
#main { margin-top: 80px; padding: 20px; padding-bottom: 60px; }
.section { padding: 20px; margin-bottom: 20px; border-radius: 12px;
  background: rgba(255,255,255,0.06); box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none;
}
#home { display: block; }
.section h3 { color: #BDA0FF; font-size: 18px; margin-bottom: 15px; }
button { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin: 5px; }
button.paystack { background: linear-gradient(135deg,#00d478,#00b96b); color: #fff; }
input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: none; margin-bottom: 12px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { padding: 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
th { background: rgba(255,255,255,0.1); }
#toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background: #333; color: #fff; padding: 12px 24px; border-radius: 50px; z-index: 10000;
  opacity: 0; transition: .3s;
}
#toast.show { opacity: 1; }
body.light { background: #f5f5f5; color: #000; }
body.light #topNav { background: #fff; }
body.light .section { background: #fff; color: #000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
/* Splash & Auth */
#splash, #authScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center; z-index: 9999;
}
#splash { background: linear-gradient(135deg,#4B0082,#6A0DAD); }
#authScreen { background: linear-gradient(135deg,#2C003E,#4B0082); opacity: 0; transition: .8s; }
#authScreen .card { background: #fff; color: #000; padding: 35px; border-radius: 16px;
  width: 90%; max-width: 380px; text-align: center; box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}
#authScreen img { height: 70px; margin-bottom: 20px; }
@keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.08);} }
/* HOME CARDS */
.home-card {
  background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px;
  margin-bottom: 15px; cursor: pointer; transition: .3s;
}
.home-card:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
.home-card h4 { margin: 0 0 8px; font-size: 16px; }
.home-card p { margin: 0; font-size: 14px; opacity: 0.9; }
/* FOOTER */
footer {
  position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.2);
  color: #fff; text-align: center; padding: 12px 20px; font-size: 14px;
  backdrop-filter: blur(5px); z-index: 999;
}
/* Charts */
.chart-container { position: relative; height: 300px; margin: 20px 0; }

/* LEADERBOARD CARDS */
.lb-container { margin-top: 15px; }
.lb-card {
  display: flex; align-items: center; padding: 12px; margin: 8px 0;
  background: rgba(255,255,255,0.1); border-radius: 12px;
  border-left: 4px solid #6A0DAD; transition: .2s;
  position: relative;
}
.lb-card.you { box-shadow: 0 0 12px #6A0DAD; font-weight: 600; }
.lb-card:hover { background: rgba(255,255,255,0.2); transform: translateX(4px); }
.lb-rank { width: 40px; text-align: center; font-size: 20px; font-weight: bold; }
.lb-medal { font-size: 24px; }
.lb-you { background: #6A0DAD; color: #fff; padding: 2px 8px; border-radius: 20px; font-size: 10px; margin-left: 8px; }

/* TABS */
.lb-tab {
  background: rgba(255,255,255,0.1);
  border: none;
  padding: 10px 20px;
  border-radius: 8px 8px 0 0;
  cursor: pointer;
  font-weight: 600;
  color: #fff;
}
.lb-tab.active {
  background: #6A0DAD;
  color: #fff;
}
.progress-bar {
  height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; margin: 8px 0;
}
.progress-bar .fill {
  height: 100%; background: #6A0DAD; width: 0%; transition: width 1s ease;
}
.progress-bar.large { height: 20px; }
.progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 12px; color: #fff; font-weight: bold; }
</style>
</head>
<body>
<!-- SPLASH -->
<div id="splash"><img src="https://i.imgur.com/jT9Dl9w.png" alt="CharisPay" style="height:140px;animation:pulse 1.5s infinite;"></div>
<!-- AUTH -->
<div id="authScreen">
  <div class="card">
    <img src="https://i.imgur.com/pG7paVl.png" alt="CharisPay">
    <h3>Welcome to CharisPay</h3>
    <form id="loginForm"><input type="email" id="loginEmail" placeholder="Email" required><input type="password" id="loginPassword" placeholder="Password" required><button type="submit">Log In</button></form>
    <!-- SIGNUP FORM -->
    <form id="signupForm" style="display:none;">
      <input type="text" id="signupName" placeholder="Full Name" required>
      <select id="signupChapter" required></select>
      <input type="email" id="signupEmail" placeholder="Email" required>
      <input type="tel" id="signupPhone" placeholder="Phone Number" required>
      <input type="password" id="signupPassword" placeholder="Password" required>
      <button type="submit">Sign Up</button>
    </form>
    <p style="margin-top:15px;font-size:14px;">
      <a href="#" id="showLogin" style="color:#6A0DAD;">Log In</a> |
      <a href="#" id="showSignup" style="color:#6A0DAD;">Sign Up</a> |
      <a href="#" id="forgotPass" style="color:#dc3545;">Forgot?</a>
    </p>
  </div>
</div>
<!-- TOP NAV -->
<div id="topNav">
  <div class="logo"><img src="https://i.imgur.com/pG7paVl.png" alt="CharisPay"></div>
  <div class="nav-icons">
    <div class="nav-icon active" data-section="home" title="Home"><i class="fas fa-home"></i></div>
    <div class="nav-icon" data-section="dashboard" title="Dashboard"><i class="fas fa-tachometer-alt"></i></div>
    <div class="nav-icon" data-section="give" title="Give"><i class="fas fa-hand-holding-heart"></i></div>
    <div class="nav-icon" data-section="statements" title="Statements"><i class="fas fa-file-invoice"></i></div>
    <div class="nav-icon" data-section="leaderboard" title="Leaderboard"><i class="fas fa-trophy"></i></div>
    <div class="nav-icon" data-section="notifications" title="Notifications"><i class="fas fa-bell"></i></div>
    <div class="nav-icon" data-section="profile" title="Profile"><i class="fas fa-user"></i></div>
    <div class="nav-icon" data-section="chapterAdmin" id="caTab" style="display:none;" title="Chapter Admin"><i class="fas fa-users-cog"></i></div>
    <div class="nav-icon" data-section="superAdmin" id="saTab" style="display:none;" title="Super Admin"><i class="fas fa-crown"></i></div>
    <div class="nav-icon" data-section="help" title="Help"><i class="fas fa-question-circle"></i></div>
    <div class="nav-icon" id="darkToggle" title="Dark/Light"><i class="fas fa-moon"></i></div>
    <div class="nav-icon" id="logout" title="Logout"><i class="fas fa-sign-out-alt"></i></div>
  </div>
</div>
<!-- MAIN -->
<div id="main">
  <!-- HOME -->
  <div class="section" id="home">
    <h3>Home</h3>
    <div class="home-card" onclick="navigateTo('dashboard')">
      <h4>Dashboard</h4>
      <p>Total Given: <strong><span id="homeTotal">0</span></strong> KES | Chapter: <strong><span id="homeChapter">Not Set</span></strong></p>
    </div>
    <div class="home-card" onclick="navigateTo('give')">
      <h4>Quick Give</h4>
      <p>Tap to give via Paystack</p>
    </div>
    <div class="home-card" onclick="navigateTo('statements')">
      <h4>Recent Statements</h4>
      <p id="homeStatements">No recent giving</p>
    </div>
    <div class="home-card" onclick="navigateTo('notifications')">
      <h4>Notifications</h4>
      <p id="homeNotifs">No new notifications</p>
    </div>
    <div class="home-card" onclick="navigateTo('profile')">
      <h4>Profile</h4>
      <p>Update name, chapter, phone</p>
    </div>
  </div>
  <!-- DASHBOARD -->
  <div class="section" id="dashboard">
    <h3>Dashboard</h3>
    <p>Total given: <strong><span id="totalAmount">0</span></strong> KES</p>
    <p>Chapter: <strong><span id="memberChapter">Not Set</span></strong></p>
  </div>
  <!-- GIVE -->
  <div class="section" id="give">
    <h3>Give</h3>
    <div id="giveStep1">
      <label>Currency</label>
      <select id="currency" required><option value="KES">KES</option></select>
      <label>Giving Type</label>
      <select id="givingType" required></select>
      <div id="otherTypeWrapper" style="display:none;"><input type="text" id="otherTypeInput" placeholder="Enter custom type"></div>
      <label>Amount</label>
      <input type="number" id="amount" placeholder="Enter amount" min="1" required>
      <button id="nextToSummaryBtn">Next</button>
    </div>
    <div id="giveStep2" style="display:none;">
      <h4>Confirm</h4>
      <p><strong>Currency:</strong> <span id="summaryCurrency">KES</span></p>
      <p><strong>Type:</strong> <span id="summaryType"></span></p>
      <p><strong>Amount:</strong> <span id="summaryAmount"></span></p>
      <p><strong>Ref:</strong> <span id="summaryRef"></span></p>
      <div style="display:flex;flex-direction:column;gap:12px;margin:20px 0;">
        <button class="paystack" onclick="payWith('paystack')">Pay with Paystack</button>
      </div>
      <button onclick="backToStep1()">Edit</button>
      <button id="printReceiptBtn" style="display:none;background:#28a745;" onclick="printReceipt()">Print Receipt</button>
    </div>
  </div>
  <!-- STATEMENTS -->
  <div class="section" id="statements">
    <h3>Statements</h3>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
      <input type="date" id="filterStart">
      <input type="date" id="filterEnd">
      <button onclick="applyFilter()">Filter</button>
      <button onclick="resetFilter()">Reset</button>
      <button id="printStatementsBtn" onclick="printStatements()" style="background:#6A0DAD;color:#fff;margin-top:10px;">Print PDF</button>
      <button id="exportCsvBtn" onclick="exportStatements('csv')" style="background:#28a745;color:#fff;margin-top:10px;">Export CSV</button>
      <button id="exportExcelBtn" onclick="exportStatements('excel')" style="background:#17a2b8;color:#fff;margin-top:10px;">Export Excel</button>
    </div>
    <table>
     <thead>
      <tr><th>Date</th><th>Ref</th><th>Type</th><th>Amount (KES)</th></tr>
     </thead>
     <tbody id="statementBody"></tbody>
    </table>
  </div>

  <!-- LEADERBOARD (UPGRADED WITH TABS) -->
  <div class="section" id="leaderboard">
    <h3>Leaderboard</h3>

    <!-- SUPER ADMIN TABS -->
    <div id="lbTabs" style="display:none; margin-bottom:15px; display:flex; gap:10px; border-bottom:1px solid rgba(255,255,255,0.2);">
      <button class="lb-tab active" data-view="chapters">Chapters</button>
      <button class="lb-tab" data-view="members">Top Members</button>
    </div>

    <!-- CHAPTER VIEW -->
    <div id="chaptersView">
      <div id="chapterLeaderboardContainer" style="display:none;">
        <h4>Your Chapter Leaderboard</h4>
        <select id="chapterLbType" style="width:auto;display:inline-block;margin:10px 0;"></select>
        <button onclick="loadChapterLeaderboard()">Load</button>
        <div id="chapterLeaderboard" class="lb-container"></div>
      </div>
      <div id="globalChaptersContainer" style="display:none;">
        <h4>Global Chapters</h4>
        <select id="globalLbChapter"></select>
        <button onclick="loadGlobalChapters()">Filter</button>
        <div id="globalChapters" class="lb-container"></div>
      </div>
    </div>

    <!-- TOP MEMBERS VIEW -->
    <div id="membersView" style="display:none;">
      <h4>Top 50 Members Worldwide</h4>
      <select id="globalMemberType" style="width:auto;display:inline-block;margin:5px;"></select>
      <select id="globalMemberChapter" style="width:auto;display:inline-block;margin:5px;"></select>
      <button onclick="loadGlobalMembers()">Load</button>
      <div id="globalMembers" class="lb-container"></div>
    </div>
  </div>

  <!-- NOTIFICATIONS -->
  <div class="section" id="notifications">
    <h3>Notifications</h3>
    <div id="notificationsList" style="max-height:400px;overflow-y:auto;"></div>
  </div>
  <!-- PROFILE -->
  <div class="section" id="profile">
    <h3>Profile</h3>
    <label>Name</label><input id="profileName">
    <label>Email</label><input id="profileEmail" disabled>
    <label>Chapter</label><select id="profileChapter"></select>
    <div id="otherChapterWrapper" style="display:none;"><input type="text" id="otherChapterInput" placeholder="Enter chapter"></div>
    <label>Phone</label><input id="profilePhone">
    <button onclick="saveProfile()">Save</button>
  </div>
  <!-- CHAPTER ADMIN -->
  <div class="section" id="chapterAdmin">
    <h3>Chapter Admin – <span id="caChapterName"></span></h3>
    <button onclick="loadChapterReport()">View Chapter Report</button>
    <div id="chapterReport" style="margin-top:15px;"></div>
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-top:15px;">
      <h4>Send Broadcast</h4>
      <textarea id="broadcastMsg" placeholder="Message to chapter"></textarea>
      <button onclick="sendBroadcast(true)">Send to Chapter</button>
    </div>
  </div>
  <!-- SUPER ADMIN -->
  <div class="section" id="superAdmin">
    <h3>Super Admin</h3>
    <!-- Global Report -->
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:15px;">
      <h4>Global Giving Report</h4>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <input type="text" id="globalFilterName" placeholder="Name">
        <select id="globalFilterType"></select>
        <input type="date" id="globalFilterStart">
        <input type="date" id="globalFilterEnd">
        <select id="globalFilterChapter"></select>
        <button onclick="loadGlobalReport()">Filter</button>
        <button onclick="resetGlobalFilter()">Reset</button>
      </div>
      <div id="globalReport" style="margin-top:15px;"></div>
    </div>
    <!-- Add Chapter -->
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:15px;">
      <h4>Add Chapter</h4>
      <input type="text" id="newChapterName" placeholder="Chapter name">
      <button onclick="addChapter()">Add</button>
    </div>
    <!-- Add Global Giving Type -->
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:15px;">
      <h4>Add Global Giving Type</h4>
      <input type="text" id="newGlobalType" placeholder="Type name">
      <button onclick="addGivingType(false)">Add</button>
    </div>
    <!-- Delete Giving Type -->
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:15px;">
      <h4>Delete Giving Type</h4>
      <select id="deleteGivingType"></select>
      <button onclick="deleteGivingType()" style="background:#dc3545;">Delete</button>
    </div>
    <!-- Promote Admin -->
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:15px;">
      <h4>Promote Chapter Admin</h4>
      <input type="email" id="adminEmail" placeholder="Member email">
      <select id="adminChapter"></select>
      <button onclick="promoteAdmin()">Promote</button>
    </div>
    <!-- Delete Admin -->
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:15px;">
      <h4>Delete Chapter Admin</h4>
      <select id="deleteAdminSelect"></select>
      <button onclick="removeAdmin()" style="background:#dc3545;">Remove</button>
    </div>
    <!-- Manage Chapters -->
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:15px;">
      <h4>Manage Chapters</h4>
      <div id="chaptersList"></div>
    </div>
    <!-- Broadcast -->
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:15px;">
      <h4>Send Global Broadcast</h4>
      <select id="globalBroadcastChapter"><option value="">All Members</option></select>
      <textarea id="globalBroadcastMsg" placeholder="Message to all or selected chapter"></textarea>
      <button onclick="sendBroadcast(false)">Send</button>
    </div>
    <!-- Analytics -->
    <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;">
      <h4>Analytics Dashboard</h4>
      <div style="margin-bottom:15px;">
        <label>View: </label>
        <select id="analyticsView" onchange="toggleAnalyticsView()">
          <option value="types">By Giving Type</option>
          <option value="member">By Member</option>
        </select>
      </div>
      <div id="analyticsTypeView">
        <input type="date" id="analyticsStart">
        <input type="date" id="analyticsEnd">
        <button onclick="loadAnalyticsByType()">Load</button>
      </div>
      <div id="analyticsMemberView" style="display:none;">
        <input type="email" id="analyticsMemberEmail" placeholder="Member Email">
        <input type="date" id="analyticsMemberStart">
        <input type="date" id="analyticsMemberEnd">
        <button onclick="loadAnalyticsByMember()">Load</button>
      </div>
      <div class="chart-container">
        <canvas id="analyticsChart"></canvas>
      </div>
    </div>
  </div>
  <!-- HELP -->
  <div class="section" id="help">
    <h3>Help</h3>
    <p>0715909038</p>
    <p>charisministriesintl22@gmail.com</p>
  </div>
</div>
<footer>CharisAppStore</footer>
<div id="toast"></div>

<!-- PDF LIBS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- GLOBAL PRINT FUNCTIONS -->
<script>
function printReceipt() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFillColor(255, 255, 255); 
  doc.rect(0, 0, 210, 40, 'F');
  doc.addImage('https://i.imgur.com/pG7paVl.png', 'PNG', (210 - 50) / 2, 10, 50, 20);
  doc.setFontSize(18); doc.setTextColor(0, 0, 0); 
  doc.text('CharisPay Receipt', 105, 55, 'center');
  doc.setDrawColor(138, 43, 226); doc.setLineWidth(1.5); 
  doc.line(60, 58, 150, 58);
  doc.setFillColor(230, 220, 255); doc.setDrawColor(75, 0, 130); doc.setLineWidth(0.5); 
  doc.rect(15, 60, 180, 60, 'FD');
  doc.setFontSize(12);
  const ref = document.getElementById('summaryRef')?.textContent || '';
  const type = document.getElementById('summaryType')?.textContent || '';
  const amount = document.getElementById('summaryAmount')?.textContent || '';
  const date = new Date().toLocaleString();
  doc.text(`Reference: ${ref}`, 20, 75);
  doc.text(`Type: ${type}`, 20, 85);
  doc.text(`Amount: KES ${amount}`, 20, 95);
  doc.text(`Date: ${date}`, 20, 105);
  doc.setFontSize(12); doc.setTextColor(75, 0, 130);
  doc.text('Transactions made Fast, Secure, & Seamless', 105, 130, 'center');
  doc.save(`Receipt_${ref.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
}

function printStatements() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.addImage('https://i.imgur.com/pG7paVl.png', 'PNG', 80, 10, 50, 20);
  doc.setFontSize(16);
  doc.text('CharisPay Statements', 105, 40, { align: 'center' });

  const rows = [];
  document.querySelectorAll('#statementBody tr').forEach(tr => {
    if (tr.textContent.includes('No statements')) return;
    const cols = Array.from(tr.querySelectorAll('td')).map(td => td.textContent);
    rows.push(cols);
  });

  if (rows.length === 0) { toast('No statements to print.'); return; }

  doc.autoTable({
    startY: 50,
    head: [['Date', 'Ref', 'Type', 'Amount (KES)']],
    body: rows,
    theme: 'grid',
    headStyles: { fillColor: [106, 13, 173] },
    styles: { fontSize: 12 },
    margin: { left: 15, right: 15 }
  });

  doc.save('CharisPay_Statements.pdf');
}
</script>

<!-- MAIN APP (MODULE) -->
<script type="module">
window.navigateTo = function(section) {
  const tab = document.querySelector(`.nav-icon[data-section="${section}"]`);
  if (tab) {
    tab.click();
  } else {
    console.warn(`No nav tab for section: ${section}`);
    showSection(section);
    document.querySelectorAll('.nav-icon').forEach(e => e.classList.remove('active'));
    const fallbackTab = document.querySelector(`.nav-icon[data-section="${section}"]`);
    if (fallbackTab) fallbackTab.classList.add('active');
  }
};

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient('https://gbuqxitxyezjptyeveud.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdidXF4aXR4eWV6anB0eWV2ZXVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2NTQ2NzQsImV4cCI6MjA3NzIzMDY3NH0.hiagI1wklBr-LJgDho4srBk7ObH7NozwaKXNJbFzqWc');

let currentUser = null, giveData = {}, offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]'), analyticsChart = null;
const PAYSTACK_KEY = 'pk_live_29beec3fe9fadec25009d17902b92a637ea615bb';

loadAppData();

window.addEventListener('load', async () => {
  setupUI();  // ← THIS MUST BE HERE
  const splash = document.getElementById('splash'), auth = document.getElementById('authScreen');
  // ... rest of code

  setTimeout(() => { 
    splash.style.opacity='0'; 
    setTimeout(() => { 
      splash.style.display='none'; 
      auth.style.opacity='1'; 
    }, 800); 
  }, 3000);

  // ... rest of login/signup logic

  const {data:{user}} = await supabase.auth.getUser(); 
  if(user) { 
    splash.style.display='none'; 
    auth.style.display='none'; 
    await initApp(); 
  }
});

async function initApp() {
  document.getElementById('authScreen').style.display='none';
  await loadUser();
  showSection('home');
  if (currentUser?.role === 'super_admin') setupLeaderboardTabs();
}

async function loadUser() {
  const {data:{user}} = await supabase.auth.getUser(); if(!user) return;
  const {data:profile} = await supabase.from('members').select('*').eq('id',user.id).single();
  currentUser = {id:profile.id,email:profile.email,name:profile.name,chapter_id:profile.chapter_id,role:profile.role||'member',total_giving:profile.total_giving||0,phone:profile.phone||''};
  localStorage.setItem('charisUser', JSON.stringify(currentUser));
  await loadAppData();
}

async function loadAppData() {
  const [{data:types},{data:chapters}] = await Promise.all([
    supabase.from('giving_types').select('id,name').order('name'),
    supabase.from('chapters').select('id,name').order('name')
  ]);

  const typeOpts = [{v:'',t:'Select'},...types.map(t=>({v:t.id,t:t.name})),...["Tithe","Offering","Pledge","Seed","Building"].map(t=>({v:'custom_'+t,t:t})),{v:'other',t:'Other'}];
  const chapterOpts = [{v:'',t:'Select Chapter'}, ...chapters.map(c => ({v: c.id, t: c.name}))];

  populate('#givingType', typeOpts);
  populate('#profileChapter', chapterOpts);
  populate('#adminChapter', chapterOpts);
  populate('#signupChapter', chapterOpts);
  populate('#globalFilterType', typeOpts);
  populate('#globalFilterChapter', chapterOpts);
  populate('#chapterLbType', typeOpts);
  populate('#globalMemberType', typeOpts);
  populate('#globalMemberChapter', chapterOpts);
  populate('#globalLbChapter', chapterOpts);
  populate('#deleteGivingType', types.map(t=>({v:t.id,t:t.name})));
  populate('#globalBroadcastChapter', [{v:'',t:'All'} ,...chapterOpts]);
  populate('#globalMemberType', typeOpts);
  populate('#globalMemberChapter', chapterOpts);

  if (currentUser) {
    document.getElementById('profileName').value = currentUser.name || '';
    document.getElementById('profileEmail').value = currentUser.email || '';
    document.getElementById('profilePhone').value = currentUser.phone || '';
    if(currentUser.chapter_id) document.getElementById('profileChapter').value = currentUser.chapter_id;

    if(currentUser.role === 'chapter_admin') {
      document.getElementById('caTab').style.display='flex';
      const {data} = await supabase.from('chapters').select('name').eq('id',currentUser.chapter_id).single();
      document.getElementById('caChapterName').textContent = data?.name || 'Unknown';
    }

    if(currentUser.role === 'super_admin') {
      document.getElementById('saTab').style.display='flex';
      loadSuperAdmin();
    }

    await Promise.all([loadDashboard(), loadStatements(), loadHomeSummary()]);
  }
}

function setupUI() {
  document.querySelectorAll('.nav-icon').forEach(el => {
    el.onclick = () => {
      document.querySelectorAll('.nav-icon').forEach(e => e.classList.remove('active'));
      el.classList.add('active');
      showSection(el.dataset.section);
    };
  });
  document.getElementById('darkToggle').onclick = () => document.body.classList.toggle('light');
  document.getElementById('logout').onclick = async () => { await supabase.auth.signOut(); localStorage.removeItem('charisUser'); location.reload(); };
  document.getElementById('givingType').onchange = () => document.getElementById('otherTypeWrapper').style.display = this.value === 'other' ? 'block' : 'none';
  document.getElementById('profileChapter').onchange = () => document.getElementById('otherChapterWrapper').style.display = this.value === 'other' ? 'block' : 'none';
  document.getElementById('nextToSummaryBtn').onclick = nextToSummary;
}

function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  const el = document.getElementById(id);
  if (el) el.style.display = 'block';
  if (id === 'home') loadHomeSummary();
  if (id === 'superAdmin') loadSuperAdmin();
  if (id === 'chapterAdmin') loadChapterReport();
  if (id === 'leaderboard') {
    document.getElementById('lbTabs').style.display = 'none';
    document.getElementById('chapterLeaderboardContainer').style.display = 'none';
    document.getElementById('globalChaptersContainer').style.display = 'none';
    document.getElementById('membersView').style.display = 'none';
    document.getElementById('chaptersView').style.display = 'block';

    if (currentUser?.role === 'chapter_admin' || !currentUser?.role) {
      document.getElementById('chapterLeaderboardContainer').style.display = 'block';
      loadChapterLeaderboard();
    } else if (currentUser?.role === 'super_admin') {
      document.getElementById('lbTabs').style.display = 'flex';
      document.getElementById('globalChaptersContainer').style.display = 'block';
      loadGlobalChapters();
      setupLeaderboardTabs();
    }
  }
}

function setupLeaderboardTabs() {
  document.querySelectorAll('.lb-tab').forEach(tab => {
    tab.onclick = () => {
      document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const view = tab.dataset.view;
      document.getElementById('chaptersView').style.display = view === 'chapters' ? 'block' : 'none';
      document.getElementById('membersView').style.display = view === 'members' ? 'block' : 'none';
      if (view === 'chapters') loadGlobalChapters();
      if (view === 'members') loadGlobalMembers();
    };
  });
}

// === CHAPTER LEADERBOARD ===
window.loadChapterLeaderboard = async () => {
  if (!currentUser.chapter_id) return toast('No chapter set');

  const type = document.getElementById('chapterLbType').value;
  const typeId = (type && !type.startsWith('custom_') && type !== 'other') ? type : null;

  const { data: members } = await supabase.from('members')
    .select('id, name, total_giving')
    .eq('chapter_id', currentUser.chapter_id);

  if (!members || members.length === 0) {
    document.getElementById('chapterLeaderboard').innerHTML = '<p style="text-align:center;color:#ccc;">No members yet.</p>';
    return;
  }

  const ranked = members
    .map(m => ({ ...m, points: Math.floor(m.total_giving / 1000) }))
    .sort((a, b) => b.points - a.points);

  const totalPoints = ranked.reduce((sum, m) => sum + m.points, 0);
  const target = 1000;
  const progress = Math.min(100, (totalPoints / target) * 100);

  document.getElementById('chapterLeaderboard').innerHTML = `
    <div class="progress-bar large">
      <div class="fill" style="width:${progress}%"></div>
      <span class="progress-text">${totalPoints} / ${target} Points</span>
    </div>
    ${ranked.map((m, i) => `
      <div class="lb-card ${m.id === currentUser.id ? 'you' : ''}" 
           style="border-left-color: ${i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : i === 2 ? '#CD7F32' : '#6A0DAD'}">
        <div class="lb-rank">
          ${i < 3 ? `<i class="fas fa-medal lb-medal" style="color:${i===0?'#FFD700':i===1?'#C0C0C0':'#CD7F32'}"></i>` : `${i+1}.`}
        </div>
        <div style="flex:1;">
          <div><strong>${m.name}</strong></div>
          <small style="opacity:0.8;">${m.points} Points (KES ${m.total_giving.toLocaleString()})</small>
        </div>
        ${m.id === currentUser.id ? '<span class="lb-you">YOU</span>' : ''}
      </div>
    `).join('')}
  `;
  animateProgressBars();
};

// === GLOBAL CHAPTERS ===
window.loadGlobalChapters = async () => {
  const chapterFilter = document.getElementById('globalLbChapter').value;
  let query = supabase.from('chapters').select('id, name, total_points, target_points');
  if (chapterFilter) query = query.eq('id', chapterFilter);
  const { data: chapters } = await query;

  const ranked = chapters
    .map(c => ({ ...c, points: c.total_points || 0, target: c.target_points || 1000 }))
    .sort((a, b) => b.points - a.points);

  document.getElementById('globalChapters').innerHTML = ranked.map((c, i) => {
    const progress = c.target ? Math.min(100, (c.points / c.target) * 100) : 0;
    return `
      <div class="lb-card" style="border-left-color: ${i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : i === 2 ? '#CD7F32' : '#6A0DAD'}">
        <div class="lb-rank">
          ${i < 3 ? `<i class="fas fa-medal lb-medal" style="color:${i===0?'#FFD700':i===1?'#C0C0C0':'#CD7F32'}"></i>` : `${i+1}.`}
        </div>
        <div style="flex:1;">
          <div><strong>${c.name}</strong></div>
          <div class="progress-bar"><div class="fill" style="width:${progress}%"></div></div>
          <small>${c.points} / ${c.target} Points</small>
        </div>
      </div>
    `;
  }).join('');
  animateProgressBars();
};

// === GLOBAL TOP 50 MEMBERS ===
window.loadGlobalMembers = async () => {
  const type = document.getElementById('globalMemberType').value;
  const chapter = document.getElementById('globalMemberChapter').value;
  const typeId = (type && !type.startsWith('custom_') && type !== 'other') ? type : null;

  let query = supabase.from('vw_member_points')
  .select('*')
  .order('points', { ascending: false })
  .limit(50);

if (chapter) query = query.eq('chapter_id', chapter);  // If filtering

  const { data: members, error } = await query;
  if (error) return toast('Error: ' + error.message);

  const ranked = members.map(m => ({ ...m, points: Math.floor(m.total_giving / 1000) }))
    .sort((a, b) => b.points - a.points);

document.getElementById('globalMembers').innerHTML = ranked.map((m, i) => `
  <div class="lb-card ${m.id === currentUser.id ? 'you' : ''}">
    <div class="lb-rank">${i < 3 ? `<i class="fas fa-medal lb-medal" style="color:${i===0?'#FFD700':i===1?'#C0C0C0':'#CD7F32'}"></i>` : `${i+1}.`}</div>
    <div style="flex:1;">
      <div><strong>${m.name}</strong> • ${m.chapter_name || 'No Chapter'}</div>
      <div style="font-size:1.4em; font-weight:bold; color:#FFD700;">${m.points} Points</div>
      <small style="opacity:0.7;">KES ${m.kes_amount.toLocaleString()}</small>
    </div>
    ${m.id === currentUser.id ? '<span class="lb-you">YOU</span>' : ''}
  </div>
`).join('');
  animateProgressBars();
};

// === ANIMATE BARS ===
function animateProgressBars() {
  document.querySelectorAll('.progress-bar .fill').forEach(bar => {
    const width = bar.style.width;
    bar.style.width = '0%';
    setTimeout(() => bar.style.width = width, 100);
  });
}

// === AUTO-REFRESH EVERY 15s ===
setInterval(() => {
  if (document.getElementById('leaderboard').style.display === 'block') {
    const activeTab = document.querySelector('.lb-tab.active')?.dataset.view;
    if (activeTab === 'members') loadGlobalMembers();
    else if (activeTab === 'chapters') loadGlobalChapters();
    else loadChapterLeaderboard();
  }
}, 15000);

// === REST OF YOUR CODE (unchanged below) ===
function navigateTo(section) {
  const tab = document.querySelector(`.nav-icon[data-section="${section}"]`);
  if (tab) {
    tab.click();  // This now works because listener is always attached
  } else {
    console.warn(`No nav tab for section: ${section}`);
    showSection(section);  // Direct fallback
    document.querySelectorAll('.nav-icon').forEach(e => e.classList.remove('active'));
    const fallbackTab = document.querySelector(`.nav-icon[data-section="${section}"]`);
    if (fallbackTab) fallbackTab.classList.add('active');
  }
}

function nextToSummary() {
  let typeId = document.getElementById('givingType').value;
  let typeName = document.querySelector('#givingType option:checked').textContent;
  if (typeId.startsWith('custom_') || typeId === 'other') {
    typeName = typeId === 'other' ? document.getElementById('otherTypeInput').value.trim() : typeId.replace('custom_', '');
    if (!typeName) return toast('Enter type name');
    typeId = null;
  }
  const amount = parseFloat(document.getElementById('amount').value);
  if (!amount || amount < 1) return toast('Valid amount');
  giveData = { typeId, typeName, amount, currency: 'KES' };
  document.getElementById('summaryType').textContent = typeName;
  document.getElementById('summaryAmount').textContent = amount.toLocaleString();
  document.getElementById('summaryCurrency').textContent = 'KES';
  document.getElementById('giveStep1').style.display = 'none';
  document.getElementById('giveStep2').style.display = 'block';
}

function backToStep1() {
  document.getElementById('giveStep1').style.display = 'block';
  document.getElementById('giveStep2').style.display = 'none';
  document.getElementById('printReceiptBtn').style.display = 'none';
}

window.payWith = async method => {
  const { amount, typeId, typeName } = giveData;
  const ref = generateRef(typeName);
  const record = { member_id: currentUser.id, type_id: typeId, type_name: typeName, amount, method, ref, currency: 'KES', created_at: new Date().toISOString(), chapter_id: currentUser.chapter_id };

  if (navigator.onLine) {
    const {error} = await supabase.from('giving').insert(record);
    if (error) return toast(error.message);
    await supabase.from('members').update({ total_giving: currentUser.total_giving + amount }).eq('id',currentUser.id);
  } else {
    offlineQueue.push({ table: 'giving', action: 'insert', data: record });
    localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
    toast('Offline: Will sync');
  }

  document.getElementById('summaryRef').textContent = ref;
  document.getElementById('printReceiptBtn').style.display = 'block';

  if (method === 'paystack') {
    PaystackPop.setup({
      key: PAYSTACK_KEY,
      email: currentUser.email,
      amount: amount * 100,
      currency: 'KES',
      ref,
      callback: () => { toast('Payment Successful!'); setTimeout(() => { loadDashboard(); loadStatements(); loadHomeSummary(); }, 2000); },
      onClose: () => toast('Payment Cancelled')
    }).openIframe();
  }
};

function populate(sel, items) {
  const el = document.querySelector(sel);
  el.innerHTML = '';
  items.forEach(i => {
    const o = document.createElement('option');
    o.value = i.v; o.textContent = i.t;
    el.appendChild(o);
  });
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function generateRef(type) {
  const year = new Date().getFullYear().toString().slice(-2);
  const rand = Math.random().toString(36).substring(2, 8).toUpperCase();
  const initials = type.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
  return `IC1${rand}AB${year}${initials}`;
}

async function loadDashboard() {
  const {data} = await supabase.from('members').select('total_giving').eq('id',currentUser.id).single();
  currentUser.total_giving = data.total_giving || 0;
  document.getElementById('totalAmount').textContent = currentUser.total_giving.toLocaleString();
  const ch = currentUser.chapter_id ? (await supabase.from('chapters').select('name').eq('id',currentUser.chapter_id).single()).data?.name : 'Not Set';
  document.getElementById('memberChapter').textContent = ch;
}

async function loadStatements() {
  let query = supabase.from('giving').select('created_at,ref,type_name,amount').eq('member_id',currentUser.id).order('created_at',{ascending:false});
  const start = document.getElementById('filterStart').value, end = document.getElementById('filterEnd').value;
  if(start) query = query.gte('created_at',start+'T00:00:00');
  if(end) query = query.lte('created_at',end+'T23:59:59');
  const {data} = await query;
  const tbody = document.getElementById('statementBody');
  if (!data || data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No statements yet. Make a payment to see them here.</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(g=>`<tr><td>${new Date(g.created_at).toLocaleDateString()}</td><td>${g.ref}</td><td>${g.type_name || 'Custom'}</td><td>KES ${g.amount.toLocaleString()}</td></tr>`).join('');
}
window.applyFilter = loadStatements;
window.resetFilter = () => { document.getElementById('filterStart').value=''; document.getElementById('filterEnd').value=''; loadStatements(); };

async function loadHomeSummary() {
  const total = currentUser.total_giving.toLocaleString();
  document.getElementById('homeTotal').textContent = total;
  const ch = currentUser.chapter_id ? (await supabase.from('chapters').select('name').eq('id',currentUser.chapter_id).single()).data?.name : 'Not Set';
  document.getElementById('homeChapter').textContent = ch;

  const {data:recent} = await supabase.from('giving').select('ref,type_name,amount,created_at').eq('member_id',currentUser.id).order('created_at',{ascending:false}).limit(1);
  document.getElementById('homeStatements').innerHTML = recent?.length ? `<strong>${recent[0].type_name}</strong>: KES ${recent[0].amount} on ${new Date(recent[0].created_at).toLocaleDateString()}` : 'No recent giving';
}

window.saveProfile = async () => {
  const name = document.getElementById('profileName').value.trim();
  const phone = document.getElementById('profilePhone').value.trim();
  let chapter_id = document.getElementById('profileChapter').value;
  if (chapter_id.startsWith('custom_') || chapter_id === 'other') chapter_id = null;

  if (!name) return toast('Name required');
  const { error } = await supabase.from('members').update({ name, phone, chapter_id }).eq('id', currentUser.id);
  if (error) return toast(error.message);

  currentUser.name = name; currentUser.phone = phone; currentUser.chapter_id = chapter_id;
  localStorage.setItem('charisUser', JSON.stringify(currentUser));
  toast('Saved!');
};

window.loadGlobalReport = async () => {
  const name = document.getElementById('globalFilterName').value.trim();
  const type = document.getElementById('globalFilterType').value;
  const start = document.getElementById('globalFilterStart').value;
  const end = document.getElementById('globalFilterEnd').value;
  const chapter = document.getElementById('globalFilterChapter').value;

  let query = supabase
    .from('giving')
    .select(`
      created_at,
      amount,
      type_name,
      ref,
      members!inner(name),
      chapters!inner(name)
    `)
    .order('created_at', { ascending: false });

  if (name) query = query.ilike('members.name', `%${name}%`);
  if (start) query = query.gte('created_at', start + 'T00:00:00');
  if (end) query = query.lte('created_at', end + 'T23:59:59');
  if (chapter) query = query.eq('members.chapter_id', chapter);
  if (type && !type.startsWith('custom_') && type !== 'other') {
    query = query.eq('type_id', type);
  }

  const { data, error } = await query;
  if (error) {
    console.error('Global Report Error:', error);
    return toast('Error: ' + error.message);
  }

  const reportDiv = document.getElementById('globalReport');
  if (!data || data.length === 0) {
    reportDiv.innerHTML = '<p style="text-align:center;color:#ccc;">No giving matches your filters.</p>';
    return;
  }

  reportDiv.innerHTML = `
    <table style="width:100%;font-size:14px;margin-top:10px;">
      <thead style="background:rgba(255,255,255,0.1);">
        <tr>
          <th>Date</th>
          <th>Name</th>
          <th>Chapter</th>
          <th>Type</th>
          <th>Amount (KES)</th>
          <th>Ref</th>
        </tr>
      </thead>
      <tbody>
        ${data.map(g => `
          <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
            <td>${new Date(g.created_at).toLocaleDateString()}</td>
            <td>${g.members?.name || 'Unknown'}</td>
            <td>${g.chapters?.name || 'None'}</td>
            <td>${g.type_name || 'Custom'}</td>
            <td>KES ${Number(g.amount).toLocaleString()}</td>
            <td>${g.ref}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
};

window.resetGlobalFilter = () => {
  document.getElementById('globalFilterName').value = '';
  document.getElementById('globalFilterType').value = '';
  document.getElementById('globalFilterStart').value = '';
  document.getElementById('globalFilterEnd').value = '';
  document.getElementById('globalFilterChapter').value = '';
  document.getElementById('globalReport').innerHTML = '<p style="text-align:center;color:#ccc;">Use filters above to view giving.</p>';
};

window.addChapter = async () => {
  const name = document.getElementById('newChapterName').value.trim();
  if (!name) return toast('Enter name');
  const {error} = await supabase.from('chapters').insert({name});
  if (error) return toast(error.message);
  toast('Chapter added');
  document.getElementById('newChapterName').value = '';
  loadAppData();
};

window.addGivingType = async () => {
  const name = document.getElementById('newGlobalType').value.trim();
  if (!name) return toast('Enter type');
  const {error} = await supabase.from('giving_types').insert({name});
  if (error) return toast(error.message);
  toast('Type added');
  document.getElementById('newGlobalType').value = '';
  loadAppData();
};

window.deleteGivingType = async () => {
  const id = document.getElementById('deleteGivingType').value;
  if (!id || !confirm('Delete this giving type?')) return;
  const {error} = await supabase.from('giving_types').delete().eq('id', id);
  if (error) return toast(error.message);
  toast('Type deleted');
  loadAppData();
};

window.promoteAdmin = async () => {
  const email = document.getElementById('adminEmail').value;
  const chapter_id = document.getElementById('adminChapter').value;
  if (!email || !chapter_id) return toast('Fill fields');
  const {data: member} = await supabase.from('members').select('id').eq('email', email).single();
  if (!member) return toast('Member not found');
  const {error} = await supabase.from('members').update({role: 'chapter_admin', chapter_id}).eq('id', member.id);
  if (error) return toast(error.message);
  toast('Admin promoted');
  loadSuperAdmin();
};

window.removeAdmin = async () => {
  const memberId = document.getElementById('deleteAdminSelect').value;
  if (!memberId || !confirm('Remove this admin?')) return;
  const {error} = await supabase.from('members').update({ role: 'member', chapter_id: null }).eq('id', memberId);
  if (error) return toast(error.message);
  toast('Admin removed');
  loadSuperAdmin();
};

window.deleteChapter = async (id) => {
  if (!confirm('Delete chapter?')) return;
  const {error} = await supabase.from('chapters').delete().eq('id', id);
  if (error) return toast(error.message);
  toast('Chapter deleted');
  loadSuperAdmin();
};

async function loadSuperAdmin() {
  const {data: chapters} = await supabase.from('chapters').select('id,name');
  const {data: admins} = await supabase.from('members').select('id,name,email,chapter_id').eq('role', 'chapter_admin');

  document.getElementById('chaptersList').innerHTML = chapters.map(c => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
      <span>${c.name}</span>
      <button onclick="deleteChapter('${c.id}')" style="background:#dc3545;font-size:12px;">Delete</button>
    </div>
  `).join('');

  document.getElementById('deleteAdminSelect').innerHTML = '';
  admins.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.id;
    opt.textContent = `${a.name} (${a.email})`;
    document.getElementById('deleteAdminSelect').appendChild(opt);
  });
}

window.toggleAnalyticsView = () => {
  const view = document.getElementById('analyticsView').value;
  document.getElementById('analyticsTypeView').style.display = view === 'types' ? 'block' : 'none';
  document.getElementById('analyticsMemberView').style.display = view === 'member' ? 'block' : 'none';
};

window.loadAnalyticsByType = async () => {
  const start = document.getElementById('analyticsStart').value;
  const end = document.getElementById('analyticsEnd').value;
  let query = supabase.from('giving').select('type_name, amount');
  if (start) query = query.gte('created_at', start + 'T00:00:00');
  if (end) query = query.lte('created_at', end + 'T23:59:59');
  const {data} = await query;

  const typeTotals = {};
  data.forEach(g => {
    const type = g.type_name || 'Custom';
    typeTotals[type] = (typeTotals[type] || 0) + g.amount;
  });

  const labels = Object.keys(typeTotals);
  const values = Object.values(typeTotals);

  if (analyticsChart) analyticsChart.destroy();
  const ctx = document.getElementById('analyticsChart').getContext('2d');
  analyticsChart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Total Given (KES)', data: values, backgroundColor: '#6A0DAD' }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
};

window.loadAnalyticsByMember = async () => {
  const email = document.getElementById('analyticsMemberEmail').value;
  const start = document.getElementById('analyticsMemberStart').value;
  const end = document.getElementById('analyticsMemberEnd').value;

  const {data: member} = await supabase.from('members').select('id').eq('email', email).single();
  if (!member) return toast('Member not found');

  let query = supabase.from('giving').select('created_at, amount').eq('member_id', member.id);
  if (start) query = query.gte('created_at', start + 'T00:00:00');
  if (end) query = query.lte('created_at', end + 'T23:59:59');
  const {data} = await query;

  const monthly = {};
  data.forEach(g => {
    const month = new Date(g.created_at).toLocaleDateString('en-CA', {year: 'numeric', month: 'short'});
    monthly[month] = (monthly[month] || 0) + g.amount;
  });

  const labels = Object.keys(monthly);
  const values = Object.values(monthly);

  if (analyticsChart) analyticsChart.destroy();
  const ctx = document.getElementById('analyticsChart').getContext('2d');
  analyticsChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Member Giving (KES)', data: values, borderColor: '#4B0082' }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
};

window.exportStatements = async (format) => {
  try {
    let query = supabase.from('giving').select('created_at,ref,type_name,amount').eq('member_id', currentUser.id).order('created_at', { ascending: false });
    const start = document.getElementById('filterStart').value;
    const end = document.getElementById('filterEnd').value;
    if (start) query = query.gte('created_at', start + 'T00:00:00');
    if (end) query = query.lte('created_at', end + 'T23:59:59');
    const { data, error } = await query;
    if (error) throw error;
    if (!data || data.length === 0) return toast('No data to export');

    if (format === 'csv') {
      const rows = data.map(r => [
        new Date(r.created_at).toLocaleDateString(),
        r.ref,
        r.type_name || 'Custom',
        `KES ${Number(r.amount).toLocaleString()}`
      ]);
      const csv = rows.map(r => r.join(',')).join('\n');
      const header = 'Date,Ref,Type,Amount (KES)\n';
      const blob = new Blob([header + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `CharisPay_Statements_${new Date().toISOString().slice(0,10)}.csv`;
      a.click(); URL.revokeObjectURL(url);
      toast('CSV downloaded');
      return;
    }

    if (format === 'excel') {
      const sheetData = data.map(r => ({
        Date: new Date(r.created_at).toLocaleDateString(),
        Ref: r.ref,
        Type: r.type_name || 'Custom',
        'Amount (KES)': Number(r.amount)
      }));
      const ws = XLSX.utils.json_to_sheet(sheetData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Statements');
      XLSX.writeFile(wb, `CharisPay_Statements_${new Date().toISOString().slice(0,10)}.xlsx`);
      toast('Excel downloaded');
    }
  } catch (err) {
    console.error('Export failed:', err);
    toast('Export failed: ' + (err.message || 'Unknown error'));
  }
};
</script>
</body>
</html>